#!/bin/bash
# X11 Media Tool v7.1
# Dependencies: scrot, swappy, ffmpeg, slop, xorg-xrandr

shot_dir=~/Pictures/Screenshots
vid_dir=~/Videos/Screen_Recordings
mkdir -p "$shot_dir" "$vid_dir"

get_shot_name() { echo "$shot_dir/screenshot-$(date +'%Y-%m-%d-%H-%M-%S').png"; }
get_vid_name() { echo "$vid_dir/record-$(date +'%Y-%m-%d-%H-%M-%S').mp4"; }

countdown() {
    echo -n "Starting in: "
    for i in {3..1}; do
        echo -n "$i... "
        sleep 1
    done
    echo "GO!"
}

while true; do
    clear
    echo "--- X11 MEDIA TOOL ---"
    echo "1) Full Screen (Clean)    4) Full Screen (Swappy)"
    echo "2) Selected Area (Clean)  5) Selected Area (Swappy)"
    echo "3) Active Window (Clean)  6) Active Window (Swappy)"
    echo "----------------------------------------------------"
    echo "7) Record Full Screen     8) Record Selected Area"
    echo "0) Quit"
    echo "-----------------------"
    read -p "Choice [0-8]: " choice

    case $choice in
        1) # Full Clean
           file=$(get_shot_name)
           scrot "$file"
           # scrot "$file" -e 'viewnior $f' # <-- 2. OPTION FOR VIEWNIOR
           echo "Saved: $file"; sleep 1 ;;
        
        2) # Area Clean
           file=$(get_shot_name)
           scrot -s "$file"
           # scrot -s "$file" -e 'viewnior $f'
           echo "Saved: $file"; sleep 1 ;;
        
        3) # Active Clean
           file=$(get_shot_name)
           scrot -u -b -d 2 "$file"
           # scrot -u -b -d 2 "$file" -e 'viewnior $f'
           echo "Saved: $file"; sleep 1 ;;

        4) # Full Swappy
           scrot -o /tmp/swp.png && swappy -f /tmp/swp.png ;;

        5) # Area Swappy
           scrot -s -o /tmp/swp.png && swappy -f /tmp/swp.png ;;

        6) # Active Swappy
           scrot -u -b -d 2 -o /tmp/swp.png && swappy -f /tmp/swp.png ;;

        7|8) # Video Recording
            if [ "$choice" == "7" ]; then
                RES=$(xrandr --current | grep '*' | head -n1 | awk '{print $1}')
                [ -z "$RES" ] && RES="1920x1080"
                INPUT_ARGS="-f x11grab -s $RES -i :0.0"
            else
                echo "Select area with mouse..."
                GEOM=$(slop -f "%g")
                [ -z "$GEOM" ] && continue
                W=$(echo $GEOM | cut -dx -f1); H=$(echo $GEOM | cut -dx -f2 | cut -d+ -f1)
                X=$(echo $GEOM | cut -d+ -f2); Y=$(echo $GEOM | cut -d+ -f3)
                W=$(( W + W % 2 )); H=$(( H + H % 2 ))
                INPUT_ARGS="-f x11grab -s ${W}x${H} -i :0.0+${X},${Y}"
            fi

            vid_file=$(get_vid_name)
            countdown
            
            echo ">> RECORDING... Press 'q' to stop <<"
            # --- 3. AUDIO OPTION (Commented out) ---
            # ffmpeg -f pulse -i default $INPUT_ARGS -c:v libx264 -pix_fmt yuv420p "$vid_file"
            # also optionally add " >/dev/null 2>&1 &" to the end of next line to disable info output except error msg
            ffmpeg $INPUT_ARGS -c:v libx264 -pix_fmt yuv420p "$vid_file"
            
            echo "Video saved to $vid_dir"
            
            # --- 4. Optionally open terminal/filemanager to the video file location
            # xdg-open "$vid_dir"
            sleep 2 ;;

        0) exit 0 ;;
        *) echo "Invalid option"; sleep 1 ;;
    esac
done
